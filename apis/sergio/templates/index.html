<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partidos Gallos Quer√©taro</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header class="app-header">
    <h1>Gallos Quer√©taro ‚Äì Partidos</h1>
    <nav>
      <button id="btn-ver">Listado</button>
      <button id="btn-nuevo">Nuevo</button>
    </nav>
  </header>

  <main id="vista-listado" class="vista activa">
    <section class="panel">
      <h2>Partidos</h2>
      <div class="acciones-inline">
        <input id="filtro" type="text" placeholder="Filtrar (local / visitante / estadio)" />
        <button id="btn-refrescar" class="sec">‚Üª</button>
      </div>
      <div class="tabla-wrapper">
        <table id="tabla-partidos" aria-describedby="Listado de partidos">
          <thead>
            <tr>
              <th>ID</th>
              <th>Local</th>
              <th>Visitante</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Estadio</th>
              <th>Resultado</th>
              <th>Mapa</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="estado" class="estado" role="status"></p>
    </section>
  </main>

  <main id="vista-form" class="vista">
    <section class="panel">
      <h2>Nuevo Partido</h2>
      <form id="form-partido" autocomplete="off">
        <div class="grid">
          <label>Equipo Local
            <input name="equipo_local" required />
          </label>
          <label>Equipo Visitante
            <input name="equipo_visitante" required />
          </label>
          <label>Fecha
            <input name="fecha" type="date" required />
          </label>
          <label>Hora
            <input name="hora" type="time" required />
          </label>
          <label>Estadio
            <input name="estadio" required />
          </label>
          <label>Resultado
            <input name="resultado" placeholder="0-0" required />
          </label>
        </div>
        <div class="form-actions">
          <button type="submit">Guardar</button>
          <button type="button" id="btn-cancelar" class="sec">Cancelar</button>
        </div>
        <p id="form-msg" class="estado"></p>
      </form>
    </section>
  </main>

  <dialog id="dlg-mapa">
    <article>
      <header>
        <h3 id="dlg-titulo">Mapa Estadio</h3>
        <button id="dlg-cerrar" aria-label="Cerrar">√ó</button>
      </header>
      <iframe id="iframe-mapa" title="Mapa del estadio" loading="lazy"></iframe>
    </article>
  </dialog>

  <footer class="app-footer">Frontend minimalista ‚Äì FastAPI</footer>

  <script>
    const API = '';
    const tablaBody = document.querySelector('#tabla-partidos tbody');
    const estado = document.getElementById('estado');
    const filtro = document.getElementById('filtro');
    const formVista = document.getElementById('vista-form');
    const listadoVista = document.getElementById('vista-listado');
    const btnVer = document.getElementById('btn-ver');
    const btnNuevo = document.getElementById('btn-nuevo');
    const form = document.getElementById('form-partido');
    const formMsg = document.getElementById('form-msg');
    const btnCancelar = document.getElementById('btn-cancelar');
    const btnRefrescar = document.getElementById('btn-refrescar');
    const dlg = document.getElementById('dlg-mapa');
    const iframeMapa = document.getElementById('iframe-mapa');
    const dlgTitulo = document.getElementById('dlg-titulo');

    function cambiarVista(v) {
      [formVista, listadoVista].forEach(x=>x.classList.remove('activa'));
      v.classList.add('activa');
    }

    btnVer.onclick = () => cambiarVista(listadoVista);
    btnNuevo.onclick = () => { form.reset(); formMsg.textContent=''; cambiarVista(formVista); };
    btnCancelar.onclick = () => cambiarVista(listadoVista);

    filtro.addEventListener('input', ()=> filtrar());
    btnRefrescar.onclick = cargarPartidos;

    async function api(path, opts={}) {
      try {
        const r = await fetch(API + path, {headers:{'Content-Type':'application/json'}, ...opts});
        if(!r.ok) throw new Error(await r.text());
        if(r.status === 204) return null;
        return await r.json();
      } catch (e) { throw e; }
    }

    async function cargarPartidos(){
      estado.textContent = 'Cargando...';
      try {
        const datos = await api('/partidos/');
        renderTabla(datos);
        estado.textContent = datos.length ? `${datos.length} partido(s)` : 'Sin datos';
      } catch(e){
        estado.textContent = 'Error: ' + e.message;
      }
    }

    function renderTabla(datos){
      tablaBody.innerHTML = '';
      datos.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.equipo_local}</td>
            <td>${p.equipo_visitante}</td>
            <td>${p.fecha}</td>
            <td>${p.hora}</td>
            <td>${p.estadio}</td>
            <td>${p.resultado}</td>
            <td><button class="link" data-map="${p.id}" data-estadio="${p.estadio}">üó∫Ô∏è</button></td>
            <td><button class="danger" data-del="${p.id}">‚úï</button></td>`;
        tablaBody.appendChild(tr);
      });
    }

    function filtrar(){
      const q = filtro.value.toLowerCase();
      [...tablaBody.rows].forEach(r => {
        const show = [...r.cells].slice(1,7).some(c => c.textContent.toLowerCase().includes(q));
        r.style.display = show ? '' : 'none';
      });
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      formMsg.textContent = 'Enviando...';
      const fd = new FormData(form);
      const obj = Object.fromEntries(fd.entries());
      try {
        // Ajuste fecha/hora (asegurar formato)
        await api('/partidos/', {method:'POST', body: JSON.stringify(obj)});
        formMsg.textContent = 'Guardado';
        setTimeout(()=> { cambiarVista(listadoVista); cargarPartidos(); }, 400);
      } catch(e){
        formMsg.textContent = 'Error: ' + e.message;
      }
    });

    tablaBody.addEventListener('click', async e => {
      const btn = e.target.closest('button');
      if(!btn) return;
      if(btn.dataset.del){
        if(confirm('¬øEliminar partido #' + btn.dataset.del + '?')){
          try { await api('/partidos/' + btn.dataset.del, {method:'DELETE'}); cargarPartidos(); } catch(err){ alert('Error: ' + err.message); }
        }
      } else if(btn.dataset.map){
        try {
          const data = await api(`/partidos/${btn.dataset.map}/estadio`);
          const { latitud, longitud, display_name } = data;
          dlgTitulo.textContent = btn.dataset.estadio;
          iframeMapa.src = `https://www.openstreetmap.org/export/embed.html?bbox=${longitud}%2C${latitud}%2C${longitud}%2C${latitud}&layer=mapnik&marker=${latitud}%2C${longitud}`;
          if(typeof dlg.showModal === 'function') dlg.showModal(); else dlg.setAttribute('open','');
        } catch(err){ alert('Error mapa: ' + err.message); }
      }
    });

    document.getElementById('dlg-cerrar').onclick = () => { if(dlg.open) dlg.close(); };

    cargarPartidos();
  </script>
</body>
</html>
